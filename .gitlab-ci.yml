image: php:8.2-cli

stages:
  - lint
  - test
  - build

variables:
  COMPOSER_CACHE_DIR: "$CI_PROJECT_DIR/.composer-cache"

cache:
  paths:
    - .composer-cache/
    - vendor/

before_script:
  - apt-get update && apt-get install -y git unzip
  - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer

lint:
  stage: lint
  script:
    - composer install
    - composer analyze
  allow_failure: true

test:
  stage: test
  script:
    - composer install
    - composer test
  allow_failure: true

build:
  stage: build
  script:
    - composer install --no-dev --optimize-autoloader
    - composer validate --strict
  only:
    - main
    - tags

# Note: Packagist automatically updates packages from repository webhooks.
# No explicit publish step needed - pushing tags to the repo triggers Packagist updates.
